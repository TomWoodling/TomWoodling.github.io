<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shuttle Starfield — Arcade Controls + Instanced Asteroids</title>
  <style>
    html,body {height:100%;margin:0;background:#000;overflow:hidden;}
    #container{width:100%;height:100%;position:relative;}
    canvas{display:block;}
    .hud{position:absolute;left:10px;top:10px;color:#fff;font-family:system-ui;pointer-events:none;}
    .stats,.ammo{margin-top:4px;}
    .reticle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:28px;height:28px;pointer-events:none;mix-blend-mode:screen;}
    .reticle-ring{width:100%;height:100%;border-radius:50%;box-shadow:0 0 12px 3px rgba(127,255,212,0.08) inset;position:absolute;}
    .reticle-dot{width:6px;height:6px;background:#7fffd4;border-radius:50%;margin:11px auto;position:absolute;left:0;right:0;}
    .dialog{position:absolute;left:50%;transform:translateX(-50%);bottom:60px;background:rgba(0,0,0,0.6);color:#fff;padding:10px;border-radius:8px;max-width:480px;text-align:left;}
    .speed-bar-container{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);width:200px;height:14px;background:#222;border:1px solid #555;}
    .speed-bar-fill{width:0%;height:100%;background:#7fffd4;}
    .speed-bar-text{position:absolute;width:100%;top:0;text-align:center;font-size:12px;color:#fff;pointer-events:none;}
  </style>

  <!-- Import map + shim for loader resolution -->
  <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports":{
      "three":"https://cdn.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
      "three/examples/jsm/":"https://cdn.jsdelivr.net/npm/three@0.179.1/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <div id="container"></div>
  <div class="reticle"><div class="reticle-ring"></div><div class="reticle-dot"></div></div>
  <div class="hud">
    <div class="stats" id="stats">Hull: 100 • Credits: 200</div>
    <div class="ammo" id="ammo">Rockets: 20</div>
  </div>
  <div class="speed-bar-container"><div class="speed-bar-fill" id="speedBar"></div><div class="speed-bar-text" id="speedText">0%</div></div>
  <div class="dialog" id="dialog" style="display:none;"></div>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/examples/jsm/loaders/DRACOLoader.js';

    const container = document.getElementById('container');
    const scene = new THREE.Scene(), renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(innerWidth, innerHeight);
    container.appendChild(renderer.domElement);

    const camera = new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,10000);
    scene.add(camera);
    scene.fog = new THREE.FogExp2(0x000011, 0.0003);
    scene.add(new THREE.HemisphereLight(0xffffff, 0x333333, 0.8));
    const dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(5,10,7);
    scene.add(dir);

    // Starfield
    function makeStarfield(n) {
      const geo = new THREE.BufferGeometry(), pos = new Float32Array(n*3), col = new Float32Array(n*3);
      for (let i=0; i<n; i++){
        const r=1200+Math.random()*2400, t=Math.random()*Math.PI*2, f=Math.acos(Math.random()*2-1);
        pos.set([r*Math.sin(f)*Math.cos(t), r*Math.sin(f)*Math.sin(t), r*Math.cos(f)], i*3);
        const b=0.8+Math.random()*0.2; col.set([b,b,b], i*3);
      }
      geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
      geo.setAttribute('color',new THREE.BufferAttribute(col,3));
      const mat = new THREE.PointsMaterial({size:1,vertexColors:true,sizeAttenuation:true});
      const pts = new THREE.Points(geo,mat); pts.frustumCulled=false;
      scene.add(pts);
    }
    makeStarfield(3000);

    // Asteroid Field via InstancedMesh
    const asteroidGeo = new THREE.IcosahedronGeometry(1,1);
    const asteroidMat = new THREE.MeshStandardMaterial({color:0x7a6f55,roughness:1});
    const asteroidField = new THREE.InstancedMesh(asteroidGeo, asteroidMat, 50);
    asteroidField.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
    scene.add(asteroidField);
    const dummy = new THREE.Object3D();
    for (let i=0; i<50; i++){
      dummy.position.set((Math.random()-0.5)*800,(Math.random()-0.5)*200,(Math.random()-0.5)*800);
      dummy.scale.setScalar(3 + Math.random()*5);
      dummy.updateMatrix();
      asteroidField.setMatrixAt(i, dummy.matrix);
    }
    asteroidField.instanceMatrix.needsUpdate = true;

    // Soft sector boundary radius
    const BOUNDARY_RADIUS = 1200;
    function applySoftBoundary(pos) {
      const dist = pos.length();
      if (dist > BOUNDARY_RADIUS) {
        pos.setLength(BOUNDARY_RADIUS * 0.95);
      }
    }

    // Loader
    const loader = new GLTFLoader();
    const draco = new DRACOLoader();
    draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
    loader.setDRACOLoader(draco);
    let ship = new THREE.Object3D(), shipLoaded=false;
    loader.load('https://TomWoodling.github.io/games/Shuttle_Mission/shuttle.gltf',
      gltf => { ship = gltf.scene; ship.scale.setScalar(0.75); ship.rotation.y = Math.PI/2; scene.add(ship); shipLoaded=true; },
      undefined, err => { console.warn(err); ship = new THREE.Mesh(new THREE.BoxGeometry(1,0.6,2), new THREE.MeshStandardMaterial({color:0x99ccff})); ship.rotation.x=Math.PI/2; ship.rotation.y=Math.PI/2; scene.add(ship); }
    );

    const player = {mesh:ship, velocity:new THREE.Vector3(), maxSpeed:80, throttle:0, rockets:20, credits:200};
    const input = {throttle:0};
    window.addEventListener('keydown', e => {
      if (e.key==='w') input.throttle=1;
      if (e.key==='s') input.throttle=-0.5;
    });
    window.addEventListener('keyup', e => {
      if (e.key==='w' || e.key==='s') input.throttle=0;
    });

    const pointer={x:0,y:0};
    window.addEventListener('mousemove', e=> {
      pointer.x = (e.clientX/innerWidth)*2 -1;
      pointer.y = -((e.clientY/innerHeight)*2 -1);
    });

    // UI
    const statsEl=document.getElementById('stats'),
          ammoEl=document.getElementById('ammo'),
          speedFill=document.getElementById('speedBar'),
          speedText=document.getElementById('speedText'),
          dialogEl=document.getElementById('dialog');
    let dialogTimer;

    function showDialog(msg,dur=2000){
      dialogEl.style.display='block';
      dialogEl.textContent=msg;
      clearTimeout(dialogTimer);
      dialogTimer=setTimeout(()=>dialogEl.style.display='none',dur);
    }

    const clock=new THREE.Clock();

    function getMouseDirection(){
      const vec = new THREE.Vector3(pointer.x, pointer.y, -1).unproject(camera).sub(camera.position).normalize();
      return vec;
    }

    function update(dt){
      if (!shipLoaded) return;

      const targetDir = getMouseDirection();
      const currDir = player.velocity.clone().normalize() || new THREE.Vector3(-1,0,0).applyQuaternion(ship.quaternion);
      currDir.lerp(targetDir, dt * 1.5).normalize();

      const speed = input.throttle * player.maxSpeed;
      player.velocity = currDir.clone().multiplyScalar(speed);

      ship.position.addScaledVector(player.velocity, dt);
      applySoftBoundary(ship.position);

      ship.quaternion.setFromUnitVectors(new THREE.Vector3(-1,0,0), currDir);

      statsEl.textContent = `Credits: ${player.credits}`;
      const pct = Math.round(player.velocity.length()/player.maxSpeed*100);
      speedFill.style.width = pct + '%';
      speedText.textContent = pct + '%';
    }

    function updateCamera(dt){
      const height=5, dist=20, damping=2;
      const desired=new THREE.Vector3(0,height,dist).applyQuaternion(ship.quaternion).add(ship.position);
      camera.position.lerp(desired, damping*dt);
      camera.lookAt(ship.position);
    }

    function animate(){
      requestAnimationFrame(animate);
      const dt = Math.min(0.05, clock.getDelta());
      update(dt);
      updateCamera(dt);
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', ()=>{
      camera.aspect=innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth,innerHeight);
    });

    console.log('Integrated arcade controls + instanced asteroids with soft boundary.');
  </script>
</body>
</html>
